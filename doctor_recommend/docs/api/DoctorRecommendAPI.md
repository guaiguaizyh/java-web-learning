# 基于自然语言的医生推荐系统 API

## 基本信息
- **基础路径**: `/recommend`
- **请求格式**: POST
- **响应格式**: JSON
- **描述**: 提供基于自然语言症状描述的智能医生推荐服务

## 推荐接口

### 通过自然语言描述推荐医生
- **接口**: `POST /recommend/doctors`
- **描述**: 通过患者自然语言描述的症状推荐最适合的医生，如果指定了userId且没有提供症状描述，将自动使用用户的医疗记录
- **权限要求**: 所有用户可访问
- **适用场景**:
  - 用户登录后主页自动推荐（仅提供userId）
  - 医生搜索页面症状输入栏（提供description）
  - 实时症状输入框（提供description）
  - AI精准推荐（使用recommendType:"AI"）

**请求体**:
```json
{
  "description": "我最近总是头痛，有时候还会头晕恶心，尤其是工作压力大的时候更严重，晚上也经常失眠",
  "userId": 123,  // 可选，用户ID
  "limit": 10,    // 可选，默认10，返回结果数量
  "recommendType": "NATURAL" // 可选，推荐类型：NATURAL(默认), AI, PROFILE
}
```

**请求参数说明**:
| 参数名称 | 类型 | 是否必需 | 描述 |
|---------|------|---------|------|
| description | String | 是* | 用户对症状的自然语言描述，可以使用日常用语（*如果提供userId且用户有医疗记录，可以为空） |
| userId | Integer | 否 | 用户ID，提供后可获得个性化推荐结果，如果description为空会尝试使用用户的医疗记录 |
| limit | Integer | 否 | 返回的医生数量限制，默认为10 |
| recommendType | String | 否 | 推荐算法类型，可选值：NATURAL(默认)、AI、PROFILE |

**用户登录后自动推荐**:
当用户登录后，可以不提供description参数，直接使用userId调用此接口。系统会自动从用户的医疗记录中获取症状信息进行推荐。

例如：
```json
{
  "userId": 123,
  "limit": 5
}
```
如果用户有医疗记录，系统会使用该记录作为症状描述；如果没有，则返回评分最高的医生。

**实时症状输入推荐**:
对于需要用户实时输入症状的场景，前端可以提供输入框，然后将用户输入作为description参数调用此接口：

```json
{
  "description": "最近几天感到头晕目眩，站起来时特别明显",
  "userId": 123,  // 可选，用户ID
  "limit": 10     // 可选，默认10
}
```

**AI精准推荐**:
对于需要使用智谱AI进行更精准推荐的场景，前端可以通过设置recommendType参数为"AI"来调用:

```json
{
  "description": "我最近总是感到头晕目眩，有时伴随耳鸣，站起来时症状会加重",
  "userId": 1001,  // 可选
  "limit": 5,      // 可选
  "recommendType": "AI"
}
```

使用AI推荐时，系统会直接使用智谱AI大模型分析症状并推荐医生，完全跳过传统的关键词匹配过程，提供更精准的医生推荐。

**响应示例**:
```json
{
  "code": 200,
  "message": "推荐成功",
  "data": [
    {
      "doctorId": 10,
      "name": "李医生",
      "gender": "女",
      "departmentName": "神经内科",
      "title": "副主任医师",
      "averageRating": 4.5,
      "ratingCount": 120,
      "avatarUrl": "/assets/avatars/doctor10.jpg",
      "expertiseList": "头痛,偏头痛,神经痛",
      "matchScore": 0.92,
      "recommendReason": "专业特长极度匹配您描述的症状（头痛、头晕、恶心），专长于头痛、偏头痛、神经痛。 患者评价良好，多位相似症状的患者选择了该医生。作为神经内科的副主任医师，在相关领域有丰富经验"
    },
    {
      "doctorId": 15,
      "name": "王医生",
      "gender": "男",
      "departmentName": "心理科",
      "title": "主治医师",
      "averageRating": 4.3,
      "ratingCount": 85,
      "avatarUrl": "/assets/avatars/doctor15.jpg",
      "expertiseList": "失眠,焦虑,抑郁",
      "matchScore": 0.85,
      "recommendReason": "专业特长非常匹配您描述的症状（失眠），专长于失眠、焦虑、抑郁。 患者评价良好。作为心理科的主治医师，在相关领域有丰富经验"
    }
  ]
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "症状描述不能为空",
  "data": null
}
```

### 基于用户病历记录推荐医生
- **接口**: `POST /recommend/doctors/ai-direct`
- **描述**: 使用智谱AI直接分析症状并推荐医生，完全跳过传统的关键词匹配过程，提供更精准的医生推荐
- **权限要求**: 所有用户可访问

**请求体**:
```json
{
  "description": "我最近总是感到头晕目眩，有时伴随耳鸣，站起来时症状会加重",
  "userId": 1001,  // 可选，用户ID
  "limit": 5,      // 可选，默认10，返回结果数量
  "debug": false   // 可选，是否返回调试信息
}
```

**请求参数说明**:
| 参数名称 | 类型 | 是否必需 | 描述 |
|---------|------|---------|------|
| description | String | 是 | 用户对症状的自然语言描述，AI将直接解析并推荐专长 |
| userId | Integer | 否 | 用户ID，提供后可结合协同过滤数据提供个性化推荐 |
| limit | Integer | 否 | 返回的医生数量限制，默认为10 |
| debug | Boolean | 否 | 是否返回AI分析的调试信息，默认为false（仅开发环境使用） |

**响应示例**:
```json
{
  "code": 200,
  "message": "推荐成功",
  "data": [
    {
      "doctorId": 42,
      "name": "张医生",
      "gender": "男",
      "departmentName": "神经内科",
      "positionsName": "主任医师",
      "workYears": 15,
      "averageRating": 4.8,
      "ratingCount": 126,
      "avatarUrl": "https://example.com/avatars/doctor42.jpg",
      "expertiseList": "头晕,眩晕症,耳鸣",
      "matchScore": 0.89,
      "recommendReason": "AI推荐：专长与您的症状相符。患者评价良好。"
    },
    {
      "doctorId": 56,
      "name": "李医生",
      "gender": "女",
      "departmentName": "神经内科",
      "positionsName": "副主任医师",
      "workYears": 12,
      "averageRating": 4.6,
      "ratingCount": 98,
      "avatarUrl": "https://example.com/avatars/doctor56.jpg",
      "expertiseList": "头晕,神经系统疾病,平衡障碍",
      "matchScore": 0.76,
      "recommendReason": "AI推荐：专长与您的症状相符。患者评价良好。"
    }
  ]
}
```

**调试模式响应示例** (仅当debug=true时返回):
```json
{
  "code": 200,
  "message": "推荐成功",
  "data": {
    "aiResponse": "神经内科,耳鼻喉科,内科,眩晕专科,神经外科",
    "parsedExpertises": ["神经内科", "耳鼻喉科", "内科", "眩晕专科", "神经外科"],
    "foundExpertiseIds": [12, 15, 8, 42, 35],
    "doctors": [
      // 医生列表与标准响应相同
    ]
  }
}
```

**特殊说明**:
1. 与传统推荐接口相比，AI直接推荐能够更好地理解复杂的症状描述
2. 当症状描述为空或为"无"时，接口会自动返回评分最高的医生列表
3. 如果AI无法识别症状或未找到匹配的医生，也会返回评分最高的医生列表
4. 此接口采用智谱AI大模型进行症状解析，响应时间可能略长于传统接口

## 兼容接口

### 关键词推荐（兼容旧版，内部转换为自然语言处理）
- **接口**: `GET /recommend/doctors/keywords`
- **描述**: 兼容旧版接口，内部会转为自然语言处理
- **注意**: 此接口仅用于兼容旧版，建议直接使用自然语言接口

**请求参数**:
| 参数名称 | 类型 | 是否必需 | 描述 |
|---------|------|---------|------|
| symptoms | String | 是 | 症状关键词，多个关键词用逗号分隔 |
| userId | Integer | 否 | 用户ID，提供后可获得个性化推荐结果 |
| limit | Integer | 否 | 返回的医生数量限制，默认为10 |

## AI与传统推荐对比

| 功能 | 传统推荐 (`recommendType:NATURAL`) | AI直接推荐 (`recommendType:AI`) |
| ---- | ---- | ---- |
| 症状识别方式 | 关键词匹配、模糊匹配 | AI自然语言理解 |
| 专长关联方式 | 基于预定义的症状-专长关联表 | AI直接推断症状与专长的关系 |
| 适用场景 | 简单明确的症状描述 | 复杂、口语化的症状描述 |
| 响应速度 | 更快 | 可能略慢（需调用AI服务） |
| 维护成本 | 需维护症状库和关联表 | 依赖AI服务质量 |
| 推荐分数计算 | 专长匹配 (40%) + 评分 (20%) + 协同过滤 (40%) | AI匹配 (60%) + 评分 (20%) + 协同过滤 (20%) |

## 错误代码

| 错误代码 | 描述 |
|---------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 404 | 未找到匹配的医生或症状 |
| 500 | 服务器内部错误 |

## 自然语言处理能力

本系统采用先进的自然语言处理技术，能够理解患者的日常语言描述，提取关键医学概念，并匹配适合的医生。主要特点包括：

### 1. 全面的语言理解能力
- **非结构化输入**: 支持患者使用自然语言描述症状，不需要使用专业医学术语
- **语义分析**: 能够理解症状的上下文信息，例如严重程度、持续时间等
- **情感识别**: 能够从描述中提取患者的痛苦程度和主观感受

### 2. 先进的医学关键词提取
- **医学术语识别**: 自动识别常见医学症状和术语
- **模糊匹配**: 即使患者使用非专业表述，也能匹配到相关医学概念
- **多级分词**: 采用滑动窗口分词技术，能够识别复合症状描述

### 3. 智能权重计算
系统对提取的关键词会进行智能权重计算，考虑以下因素：
- **症状重要性**: 不同症状的医学重要性权重不同（如胸痛比轻微头痛权重更高）
- **语义强度**: 根据"严重"、"剧烈"等描述词调整权重
- **时间因素**: 根据"长期"、"一直"等时间词调整权重
- **位置分析**: 患者描述开头的症状通常更为关注，给予更高权重
- **频率分析**: 重复提及的症状可能更重要

### 4. 精准的医生匹配
- **专长匹配**: 根据提取的医学概念匹配医生专长
- **专业熟练度**: 考虑医生对相关专长的熟练程度
- **部分匹配**: 能够识别相关但不完全匹配的专长（如"头痛"和"偏头痛"）
- **协同过滤**: 结合其他相似患者的选择偏好

### 5. 个性化推荐理由
- **详细解释**: 系统会生成详细的推荐理由，包括症状匹配情况、医生专长、患者评价等
- **医生背景**: 综合医生职称、科室等信息生成更全面的推荐说明
- **专业术语转换**: 将医学术语转换为患者易于理解的语言

## 使用示例

### 示例1: 描述头痛症状
```json
POST /recommend/doctors
{
  "description": "我最近经常头痛，特别是额头部位，有时候还会伴随着眼睛酸痛，工作一天后更严重"
}
```

### 示例2: 描述消化系统问题
```json
POST /recommend/doctors
{
  "description": "吃完饭总是感觉胃不舒服，胀气，有时候还会反酸，已经持续一个多月了"
}
```

### 示例3: 描述心理健康问题
```json
POST /recommend/doctors
{
  "description": "最近总是睡不好，心情低落，对什么事情都提不起兴趣，工作也无法集中注意力"
}
```

### 示例4: 用户登录后自动推荐
```json
POST /recommend/doctors
{
  "userId": 123,
  "limit": 5
}
```

### 示例5: 使用AI精准推荐
```json
POST /recommend/doctors
{
  "description": "我感到头晕目眩，有时伴随耳鸣，站起来时症状加重",
  "recommendType": "AI",
  "limit": 5
}
```

## 推荐算法说明
- 推荐结果基于以下因素：
  1. 专长匹配度（权重40%）：医生专长与症状的相关程度
  2. 评分权重（权重20%）：医生的平均评分和评价数量
  3. 协同过滤（权重40%）：基于相似用户的评价推荐

推荐分数计算方式：
```
最终分数 = (专长匹配分数 × 0.4) + (评分权重 × 0.2) + (协同过滤分数 × 0.4)
```

## 使用建议
1. **尽量详细描述**: 详细描述症状的位置、性质、持续时间和严重程度，有助于系统做出更准确的匹配
2. **使用日常语言**: 无需使用专业医学术语，系统能理解日常的症状描述
3. **提供用户ID**: 提供用户ID可获得基于历史就诊记录的个性化推荐
4. **说明相关因素**: 提及可能的诱因、缓解和加重因素，有助于更精准的匹配 

## 前端实现建议

### 推荐模式选择
为了充分利用系统的推荐能力，建议前端设计两个不同的推荐入口：

1. **标准推荐按钮**
   - 调用 `/recommend/doctors` 接口，使用默认的NATURAL推荐类型
   - 适用于简单明确的症状描述
   - 按钮文案建议：`快速推荐` 或 `获取推荐`
   - 响应速度快，适合大多数场景

2. **AI精准推荐按钮**
   - 调用 `/recommend/doctors` 接口，指定`recommendType:"AI"`参数
   - 适用于复杂、口语化的症状描述
   - 按钮文案建议：`AI精准推荐` 或 `深度分析`
   - 可添加提示：`适用于复杂症状描述`

### 示例实现代码：
```javascript
// 标准推荐
function standardRecommend(symptomText) {
  return api.post('/recommend/doctors', {
    description: symptomText,
    userId: this.currentUserId, // 可选
    limit: 10
  });
}

// AI精准推荐
function aiPreciseRecommend(symptomText) {
  return api.post('/recommend/doctors', {
    description: symptomText,
    userId: this.currentUserId, // 可选
    limit: 10,
    recommendType: 'AI'
  });
}
```

### 用户登录后的自动推荐
对于用户登录后的首页自动推荐，可以使用统一推荐接口：

```javascript
// 用户登录成功后
login().then((userData) => {
  // 获取个性化推荐（使用通用接口）
  api.post('/recommend/doctors', {
    userId: userData.userId,
    limit: 5
  }).then(response => {
    if (response.code === 200) {
      // 显示推荐医生
      this.recommendedDoctors = response.data;
    }
  });
  
  // 跳转到首页
  router.push('/home');
});
```

### AI推荐与聊天客服区别
- **AI精准推荐**：
  - 单次交互，用户输入症状后直接返回医生推荐
  - 专注于医生推荐结果
  - 适合明确需要找医生的用户

- **AI聊天客服**：
  - 多轮对话式交互，可讨论健康问题
  - 提供健康咨询、症状解释和建议
  - 可在对话中请求推荐医生，但主要目的是健康咨询
  - 调用 `/ai/chat` 和 `/ai/recommend-doctors` 接口

### 示例页面布局

```
[搜索/症状输入框]
[快速推荐] [AI精准推荐]  <- 两个不同按钮

---------- 或 ----------

[搜索/症状输入框]
[获取推荐] 
[✓] 使用AI深度分析 (需要更长响应时间)  <- 复选框选项
```

### 错误处理建议
- 当AI服务不可用时，自动降级到传统推荐
- 添加适当的加载状态，特别是AI精准推荐可能需要较长处理时间
- 对于无匹配结果的情况，显示评分较高的通用推荐 